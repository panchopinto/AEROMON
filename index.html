<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AEROMON ‚Äî ESP8266 (Aerop√≥nico)</title>
  <link rel="stylesheet" href="css/styles.css"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script defer src="js/config.js"></script>
</head>
<body>
<header class="topbar">
  <div class="brand-logo"><img src="assets/logo.svg" alt="Logo"/><div class="brand">Portafolio Privado</div></div>
  <nav class="nav">
    <a class="tab" href="dashboard.html">Panel</a>
    <button class="tab" id="btnBackPortfolio">‚üµ Volver al Portafolio</button>
  </nav>
</header>

<main class="hero">
  <section class="glass">
    <span class="logo-badge">Monitoreo Aerop√≥nico</span>
    <h1>AEROMON ‚Äî ESP8266</h1>
    <p>Temperatura y humedad desde tu aerop√≥nico a Google Sheets, con tablero listo para ferias y portafolio.</p>

    <div class="cta-grid">
      <a class="btn xl primary" href="dashboard.html">üìä Ver Panel</a>
      <a class="btn xl secondary" href="https://github.com/" target="_blank" rel="noopener">üåê Ver en GitHub</a>
    </div>

    <div id="clockBox" class="clock"><div class="time" id="clkTime">--:--:--</div><div class="date" id="clkDate">‚Äî</div></div>

    <div class="index-grid" id="kpiWrap">
  <article class="card kpi">
    <div class="label">√öltima lectura</div>
    <div class="big" id="idxLastTime">--</div>
  </article>
  <article class="card kpi">
    <div class="label">Temperatura</div>
    <div class="big" id="idxTemp">--</div>
    <span class="badge" id="idxTempState">‚Äî</span>
  </article>
  <article class="card kpi">
    <div class="label">Humedad</div>
    <div class="big" id="idxHum">--</div>
    <span class="badge" id="idxHumState">‚Äî</span>
  </article>
</div>

<ul class="bullets">
      <li>Botones grandes y accesibles (estilo vidrio y gradientes).</li>
      <li>Panel con tabla + gr√°fico (√∫ltimos N registros) con l√≠mites din√°micos.</li>
      <li>Listo para GitHub Pages (carpeta <code>docs</code>).</li>
    </ul>
  </section>
</main>

<footer class="footer">
  <small>¬© 2025 ‚Äî Proyecto educativo en el Liceo Bicentenario de Excelencia Polivalente San Nicol√°s.</small>
</footer>

<script>
  document.getElementById('btnBackPortfolio').addEventListener('click', ()=>{
    if(typeof PORTAFOLIO_URL==='string' && PORTAFOLIO_URL){
      window.location.href = PORTAFOLIO_URL;
    } else {
      alert('Configura PORTAFOLIO_URL en js/config.js');
    }
  });
  function updateClock(){
    try{
      const tEl = document.getElementById('clkTime');
      const dEl = document.getElementById('clkDate');
      const now = new Date();
      if(tEl) tEl.textContent = now.toLocaleTimeString('es-CL', { hour12:false });
      if(dEl) dEl.textContent = now.toLocaleDateString('es-CL', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    }catch(e){}
  }
  updateClock();
  setInterval(updateClock, 1000);
  async function loadLastFromCSV(){
    try{
      const url = (typeof SHEET_GVIZ_URL==='string' && SHEET_GVIZ_URL) ? SHEET_GVIZ_URL : SHEET_CSV_URL;
      if(!url) return;
      const res = await fetch(url + (url.includes('?')?'&':'?') + '_cb=' + Date.now(), {cache:'no-store'});
      const txt = await res.text();
      const parsed = await new Promise(resolve=> Papa.parse(txt, {header:false, dynamicTyping:true, complete: resolve}));
      let rows = parsed.data.filter(r=> r && r.length>=3 && r[0] !== "");
      rows = rows.map(r=> [new Date(r[0]), Number(r[1]), Number(r[2]), (r[3]||"")+"" ])
                 .filter(r=> !isNaN(r[0].getTime()) && !isNaN(r[1]) && !isNaN(r[2]));
      if(rows.length===0) return;
      const last = rows[rows.length-1];

      // Render
      const timeEl = document.getElementById('idxLastTime');
      const tEl = document.getElementById('idxTemp');
      const hEl = document.getElementById('idxHum');
      const tState = document.getElementById('idxTempState');
      const hState = document.getElementById('idxHumState');
      if(timeEl) timeEl.textContent = last[0].toLocaleString();
      if(tEl) tEl.textContent = last[1].toFixed(1) + " ¬∞C";
      if(hEl) hEl.textContent = last[2].toFixed(0) + " %";

      // Estado por umbrales
      function applyBadge(el, val, lo, hi){
        if(!el) return;
        el.className = "badge"; // reset
        if(val < lo*0.9 || val > hi*1.1){ el.classList.add('alert'); el.textContent = "Alerta"; }
        else if(val < lo || val > hi){ el.classList.add('warn'); el.textContent = "Advertencia"; }
        else { el.classList.add('ok'); el.textContent = "En rango"; }
      }
      applyBadge(tState, last[1], TEMP_OK_MIN, TEMP_OK_MAX);
      applyBadge(hState, last[2], HUM_OK_MIN, HUM_OK_MAX);
    }catch(e){ /* ignore */ }
  }
  loadLastFromCSV();
</script>
</body>
</html>
